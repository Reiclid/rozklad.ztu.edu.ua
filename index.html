<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>–†–æ–∑–∫–ª–∞–¥ –≥—Ä—É–ø (–Ü–ü–ó, –í–¢, –ö–ù)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="face.png">

    <!-- Open Graph (OG) —Ç–µ–≥–∏ –¥–ª—è —Å–æ—Ü–º–µ—Ä–µ–∂ -->
    <meta property="og:url" content="https://reiclid.github.io/rozklad.ztu.edu.ua/">
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://i.imgur.com/YbjxjPD.png">
    <meta property="og:image:type" content="image/png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:site_name" content="–†–æ–∑–∫–ª–∞–¥-–≥—Ä—É–ø">
    <meta property="og:title" content="–†–æ–∑–∫–ª–∞–¥ –≥—Ä—É–ø (–Ü–ü–ó, –í–¢, –ö–ù)">
    <meta property="og:description" content="–û–±–µ—Ä—ñ—Ç—å —Å–≤–æ—é –≥—Ä—É–ø—É —Ç–∞ –ø–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω–∏–π —Ä–æ–∑–∫–ª–∞–¥ –∑–∞–Ω—è—Ç—å!">
    

    <!-- Twitter Card (–¥–ª—è Twitter/X) -->
    <!-- <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="–†–æ–∑–∫–ª–∞–¥ –≥—Ä—É–ø (–Ü–ü–ó, –í–¢, –ö–ù)">
    <meta name="twitter:description" content="–û–±–µ—Ä—ñ—Ç—å —Å–≤–æ—é –≥—Ä—É–ø—É —Ç–∞ –ø–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω–∏–π —Ä–æ–∑–∫–ª–∞–¥ –∑–∞–Ω—è—Ç—å!">
    <meta name="twitter:image" content="https://i.imgur.com/YbjxjPD.png">
    <meta name="twitter:url" content="https://reiclid.github.io/rozklad.ztu.edu.ua/"> -->
</head>
<body>
  <div class="container">
    <h1>–†–æ–∑–∫–ª–∞–¥ –≥—Ä—É–ø</h1>
    <header>
        <div id="groupContainer">
            <label for="groupSelect">–û–±–µ—Ä—ñ—Ç—å –≥—Ä—É–ø—É:</label>
            <select id="groupSelect">
              <option value="">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≥—Ä—É–ø...</option>
            </select>
          </div>
          
          <ul id="dayMenu">
            <!-- –ú–µ–Ω—é –¥–ª—è –≤–∏–±–æ—Ä—É –¥–Ω—è –±—É–¥–µ –∑–∞–ø–æ–≤–Ω–µ–Ω–µ —Å–∫—Ä–∏–ø—Ç–æ–º -->
          </ul>
    </header>
    <main>
        <div id="scheduleContainer">
        <!-- –†–æ–∑–∫–ª–∞–¥ –≤—ñ–¥–æ–±—Ä–∞–∑–∏—Ç—å—Å—è —É –≤–∏–≥–ª—è–¥—ñ –∫–∞—Ä—Ç–æ–∫ -->
        </div>
    </main>
    <footer>
        <p>by reiclid</p>
    </footer>
    
  </div>
  
  <script>
    async function getProxyUrl() {
        try {
            const response = await fetch('proxy.txt');
            const text = await response.text();
            const urls = text
            .split(/\r?\n/)
            .map(url => url.trim().replace(/^["']|["']$/g, '')) // –í–∏–¥–∞–ª—è—î–º–æ –ª–∞–ø–∫–∏ –∑ –ø–æ—á–∞—Ç–∫—É —ñ –∫—ñ–Ω—Ü—è
            .filter(url => url.length > 0); // –§—ñ–ª—å—Ç—Ä—É—î–º–æ –ø–æ—Ä–æ–∂–Ω—ñ —Ä—è–¥–∫–∏

            for (const url of urls) {
                if (!url) continue; // –Ü–≥–Ω–æ—Ä—É—î–º–æ –ø—É—Å—Ç—ñ —Ä—è–¥–∫–∏
                console.log(`üîç –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ URL: ${url}`);
                try {
                    // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Ä–µ–∂–∏–º "no-cors", —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è –±—Ä–∞—É–∑–µ—Ä–æ–º
                    const checkResponse = await fetch(url + '/iscorsneeded', { method: 'GET', mode: 'no-cors' });

                    // –Ø–∫—â–æ fetch –Ω–µ –≤–∏–∫–∏–Ω—É–≤ –ø–æ–º–∏–ª–∫—É, –≤–≤–∞–∂–∞—î–º–æ –ø—Ä–æ–∫—Å—ñ —Ä–æ–±–æ—á–∏–º
                    console.log(`‚úÖ –†–æ–±–æ—á–∏–π URL –∑–Ω–∞–π–¥–µ–Ω–æ: ${url}`);
                    return url.endsWith('/') ? url : url + '/'; // –ü–µ—Ä–µ–∫–æ–Ω—É—î–º–æ—Å—è, —â–æ —î `/` –≤ –∫—ñ–Ω—Ü—ñ
                } catch (err) {
                    console.warn(`‚ùå URL –Ω–µ –ø—Ä–∞—Ü—é—î: ${url}`, err);
                }
            }
            
            throw new Error("‚ùå –ù–µ–º–∞—î —Ä–æ–±–æ—á–∏—Ö –ø—Ä–æ–∫—Å—ñ!");
        } catch (err) {
            console.error("‚ùå –ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –ø—Ä–æ–∫—Å—ñ URL:", err);
            return null;
        }
    }

    let proxyUrl = '';
    let baseUrl = '';
    let groupListUrl = '';

    getProxyUrl().then(url => {
        if (url) {
            proxyUrl = url;
            console.log("üü¢ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è Proxy URL –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ:", proxyUrl);
            baseUrl = 'https://rozklad.ztu.edu.ua';
            console.log("üü¢ baseList URL –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ:", baseUrl);
            groupListUrl = proxyUrl + 'proxy?url=https://rozklad.ztu.edu.ua/schedule/group/list';
            console.log("üü¢ groupList URL –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ:", groupListUrl);
            // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ proxyUrl –≤ —ñ–Ω—à–∏—Ö —á–∞—Å—Ç–∏–Ω–∞—Ö –∫–æ–¥—É
            loadGroups();
            if (groupSelect.value) {
                loadSchedule();
            }
        } else {
            console.error("üö® –ù–µ–º–∞—î —Ä–æ–±–æ—á–æ–≥–æ –ø—Ä–æ–∫—Å—ñ!");
        }
    });

    // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø—Ä–æ–∫—Å—ñ —ñ –±–∞–∑–æ–≤–∏—Ö URL
    //const proxyUrl = 'https://60a1-193-194-126-219.ngrok-free.app/';
    
    
    const groupSelect = document.getElementById('groupSelect');
    const dayMenu = document.getElementById('dayMenu');
    const scheduleContainer = document.getElementById('scheduleContainer');
    const days = ['–ü–æ–Ω–µ–¥—ñ–ª–æ–∫', '–í—ñ–≤—Ç–æ—Ä–æ–∫', '–°–µ—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä', "–ü'—è—Ç–Ω–∏—Ü—è", '–°—É–±–æ—Ç–∞', '–ù–µ–¥—ñ–ª—è'];

    
    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏
    const isReload = (() => {
      try {
        return performance.getEntriesByType("navigation")[0].type === "reload";
      } catch {
        return performance.navigation?.type === performance.navigation.TYPE_RELOAD;
      }
    })();
    
    // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤–∏–±—Ä–∞–Ω–æ–≥–æ –¥–Ω—è –∑ localStorage
    let selectedDayIndex = parseInt(localStorage.getItem('selectedDayIndex')) || 0;

    function showLoader() {
      return '<div class="loader">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';
    }

    function showError(message) {
      return `<div class="error-message">${message}</div>`;
    }

    function populateDayMenu() {
      console.log("üìå –ó–∞–ø–æ–≤–Ω—é—î–º–æ –º–µ–Ω—é –¥–Ω—ñ–≤");
      dayMenu.innerHTML = days
        .map((day, index) => `
          <li data-index="${index}" 
              class="${index === selectedDayIndex ? 'active' : ''}"
              onclick="selectDay(${index})">
            ${day}
          </li>
        `).join('');
    }
    
    function selectDay(index) {
      console.log(`üìå –í–∏–±—Ä–∞–Ω–æ –¥–µ–Ω—å: ${days[index]}`);
      selectedDayIndex = index;
      localStorage.setItem('selectedDayIndex', index);
      updateDayMenu();
      if (groupSelect.value) {
        loadSchedule();
      }
    }
    
    function updateDayMenu() {
      console.log("üìå –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∏–ª—ñ–≤ –¥–ª—è –≤–∏–±—Ä–∞–Ω–æ–≥–æ –¥–Ω—è");
      dayMenu.querySelectorAll('li').forEach(item => {
        item.classList.toggle('active', parseInt(item.dataset.index) === selectedDayIndex);
      });
    }
    
    function populateGroupSelect(groups) {
      console.log("üìå –ó–∞–ø–æ–≤–Ω—é—î–º–æ —Å–ø–∏—Å–æ–∫ –≥—Ä—É–ø", groups);
      const options = ['<option value="">–û–±–µ—Ä—ñ—Ç—å –≥—Ä—É–ø—É</option>']
        .concat(groups.map(group => `<option value="${group.href}">${group.name}</option>`));

      groupSelect.innerHTML = options.join('');

      const storedGroup = localStorage.getItem('selectedGroup');
      if (storedGroup) {
        console.log(`üìå –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –≤–∏–±—Ä–∞–Ω—É –≥—Ä—É–ø—É: ${storedGroup}`);
        groupSelect.value = storedGroup;
      }
    }
    
    async function loadGroups() {
        if (!proxyUrl) {
            console.log("‚è≥ –û—á—ñ–∫—É—î–º–æ proxyUrl –ø–µ—Ä–µ–¥ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è–º –≥—Ä—É–ø...");
            setTimeout(loadGroups, 500); // –ü–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ 0.5 —Å–µ–∫—É–Ω–¥–∏
            return;
        }

        try {
            console.log("üîÑ –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –≥—Ä—É–ø–∏ –∑ —Å–µ—Ä–≤–µ—Ä–∞:", groupListUrl);

            const response = await fetch(groupListUrl, {
                mode: "cors",
                headers: {
                    "ngrok-skip-browser-warning": "true",
                    "X-Requested-With": "XMLHttpRequest"
                }
            });

            if (!response.ok) throw new Error(`‚ùå –°–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä–Ω—É–≤ –ø–æ–º–∏–ª–∫—É: ${response.status}`);

            const html = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');

            const groups = Array.from(doc.querySelectorAll('.courses-list .groups-list a'))
                .filter(anchor => /^(–Ü–ü–ó(?!–∫)|–í–¢(?!–∫)|–ö–ù(?!–∫))/.test(anchor.textContent.trim()))
                .map(anchor => ({
                    name: anchor.textContent.trim(),
                    href: new URL(anchor.getAttribute('href'), baseUrl).toString()
                }));

            localStorage.setItem('cachedGroups', JSON.stringify(groups));
            populateGroupSelect(groups);
            if (groupSelect.value) {
                loadSchedule();
            }

        } catch (err) {
            console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≥—Ä—É–ø:', err);
            groupSelect.innerHTML = '<option value="">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≥—Ä—É–ø</option>';
        }
        }

    
    async function loadSchedule() {
      if (!groupSelect.value) {
        scheduleContainer.innerHTML = '';
        return;
      }

      const selectedGroupName = groupSelect.options[groupSelect.selectedIndex].text;
      const scheduleCacheKey = `cachedSchedule_${groupSelect.value}_${selectedDayIndex}`;

      console.log(`üìå –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Ä–æ–∑–∫–ª–∞–¥ –¥–ª—è ${selectedGroupName} (${days[selectedDayIndex]})`);
      const cachedSchedule = localStorage.getItem(scheduleCacheKey);
      if (cachedSchedule) {
        console.log("‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –∫–µ—à–æ–≤–∞–Ω–∏–π —Ä–æ–∑–∫–ª–∞–¥");
        scheduleContainer.innerHTML = cachedSchedule;
        return;
      }

      scheduleContainer.innerHTML = showLoader();

      try {
        console.log("üîÑ –ó–∞–ø–∏—Ç —Ä–æ–∑–∫–ª–∞–¥—É –∑ —Å–µ—Ä–≤–µ—Ä–∞...", groupSelect.value);
        const response = await fetch(proxyUrl + groupSelect.value, {
            mode: "cors",
            headers: {
                "ngrok-skip-browser-warning": "true",
                //"Origin": baseUrl,
                "X-Requested-With": "XMLHttpRequest"
            }
        });

        if (!response.ok) throw new Error(`‚ùå –°–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä–Ω—É–≤ –ø–æ–º–∏–ª–∫—É: ${response.status}`);

        const html = await response.text();
        console.log("‚úÖ –û—Ç—Ä–∏–º–∞–Ω–æ HTML —Ä–æ–∑–∫–ª–∞–¥—É");
        const doc = new DOMParser().parseFromString(html, 'text/html');

        const table = doc.querySelector('.wrapper table.schedule');
        if (!table) throw new Error('‚ùå –†–æ–∑–∫–ª–∞–¥ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');

        const scheduleHTML = `
          <h2>–†–æ–∑–∫–ª–∞–¥ –¥–ª—è ${selectedGroupName} (${days[selectedDayIndex]})</h2>
          ${Array.from(table.querySelectorAll('tbody tr'))
            .map(row => {
              const hourTh = row.querySelector('th.hour-name');
              if (!hourTh) return '';

              const periodNumber = hourTh.querySelector('.name')?.textContent.trim() || '';
              const timeRange = hourTh.querySelector('.full-name')?.textContent.trim() || '';
              const details = row.querySelectorAll('td')[selectedDayIndex]?.innerHTML.trim() || '<em>–í—ñ–ª—å–Ω–æ</em>';

              return `
                <div class="schedule-card">
                  <h3>–ü–∞—Ä–∞ ${periodNumber} (${timeRange})</h3>
                  <p>${details}</p>
                </div>
              `;
            })
            .join('')}
        `;

        scheduleContainer.innerHTML = scheduleHTML;
        localStorage.setItem(scheduleCacheKey, scheduleHTML);
      } catch (err) {
        console.error("‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä–æ–∑–∫–ª–∞–¥—É:", err);
        scheduleContainer.innerHTML = showError("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä–æ–∑–∫–ª–∞–¥—É");
      }
    }
    
    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
    populateDayMenu();
    loadGroups();
    
    // –ü–æ–¥—ñ—ó
    groupSelect.addEventListener('change', () => {
      localStorage.setItem('selectedGroup', groupSelect.value);
      loadSchedule();
    });


    function updateCardEffects() {
        const cards = document.querySelectorAll('.schedule-card');
        const viewportHeight = window.innerHeight;

        cards.forEach(card => {
            const rect = card.getBoundingClientRect();
            const cardCenter = rect.top + rect.height / 2;
            const viewportCenter = viewportHeight / 2;

            // –í—ñ–¥—Å—Ç–∞–Ω—å –≤—ñ–¥ —Ü–µ–Ω—Ç—Ä—É –µ–∫—Ä–∞–Ω—É
            const distanceFromCenter = cardCenter - viewportCenter;

            // –ù–æ—Ä–º–∞–ª—ñ–∑–æ–≤–∞–Ω–∞ –≤—ñ–¥—Å—Ç–∞–Ω—å –≤—ñ–¥ —Ü–µ–Ω—Ç—Ä—É (-1 = –≤–µ—Ä—Ö, 1 = –Ω–∏–∑)
            const normalizedDistance = distanceFromCenter / viewportHeight;

            // –í–∏–∑–Ω–∞—á–∞—î–º–æ –º–∞—Å—à—Ç–∞–± (–≤—ñ–¥ 1 –¥–æ 0.8)
            let scale = 1 - Math.min(Math.abs(normalizedDistance) * 0.2, 0.2);

            // –í–∏–∑–Ω–∞—á–∞—î–º–æ –∫—É—Ç –Ω–∞—Ö–∏–ª—É (–≤—ñ–¥ -20deg –¥–æ 20deg)
            // let tilt = Math.min(Math.max(normalizedDistance * 20, -20), 20);

            // –î–æ–¥–∞—î–º–æ –∫–ª–∞—Å –¥–ª—è –ø–ª–∞–≤–Ω–æ—ó –∞–Ω—ñ–º–∞—Ü—ñ—ó
            if (Math.abs(normalizedDistance) < 0.5) {
                card.classList.add('in-view');
            } else {
                card.classList.remove('in-view');
            }

            // –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ —Å—Ç–∏–ª—ñ
            card.style.transform = `scale(${scale})`;
            card.style.opacity = scale * scale;
        });
    }

    // –í–∏–∫–ª–∏–∫–∞—î–º–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—á—É–≤–∞–Ω–Ω—ñ
    window.addEventListener('scroll', updateCardEffects);
    window.addEventListener('resize', updateCardEffects);
    document.addEventListener('DOMContentLoaded', updateCardEffects);
    

  </script>
</body>
</html>